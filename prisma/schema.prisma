// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CLIENT
}

enum StatutVehicule {
  EN_SERVICE
  EN_MAINTENANCE
  HORS_SERVICE
}

enum StatutTrajet {
  DISPONIBLE
  ANNULE
  COMPLET
}

enum StatutReservation {
  CONFIRMEE
  EN_ATTENTE
  ANNULEE
}

enum MethodePaiement {
  CARTE_BANCAIRE
  MOBILE_MONEY
  ESPECES
}

enum TypeAbonnement {
  MENSUEL
  ANNUEL
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  role          Role      @default(CLIENT)
  nom           String
  prenom        String
  telephone     String
  pieceIdentite String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  reservations  Reservation[]
  paiements     Paiement[]
  abonnements   Abonnement[]
}

model Trajet {
  id              String         @id @default(cuid())
  villeDepart     String
  villeArrivee    String
  distance        Float          // en km
  dureeEstimee    Int            // en minutes
  tarifBase       Float
  statut          StatutTrajet   @default(DISPONIBLE)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  horaires        Horaire[]
}

model Vehicule {
  id                String         @id @default(cuid())
  numeroImmatriculation String     @unique
  marque            String
  modele            String
  capaciteMaximale  Int
  statut            StatutVehicule @default(EN_SERVICE)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  horaires          Horaire[]
}

model Conducteur {
  id                String    @id @default(cuid())
  nom               String
  prenom            String
  numeroPermis      String    @unique
  experience        Int       // nombre d'années
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  horaires          Horaire[]
}

model Horaire {
  id              String    @id @default(cuid())
  dateDepart      DateTime
  dateArrivee     DateTime
  trajetId        String
  vehiculeId      String
  conducteurId    String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  trajet          Trajet    @relation(fields: [trajetId], references: [id], onDelete: Cascade)
  vehicule        Vehicule  @relation(fields: [vehiculeId], references: [id], onDelete: Cascade)
  conducteur      Conducteur @relation(fields: [conducteurId], references: [id], onDelete: Cascade)
  
  reservations    Reservation[]
  
  @@index([dateDepart])
  @@index([vehiculeId, dateDepart])
}

model Reservation {
  id              String            @id @default(cuid())
  userId          String
  horaireId       String
  nombrePlaces    Int
  numeroSiege     String?
  statut          StatutReservation @default(EN_ATTENTE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  horaire         Horaire           @relation(fields: [horaireId], references: [id], onDelete: Cascade)
  
  paiements       Paiement[]
  bagages         Bagage[]
}

model Paiement {
  id                String          @id @default(cuid())
  reservationId     String
  userId            String
  montant           Float
  methodePaiement   MethodePaiement
  datePaiement      DateTime        @default(now())
  numeroFacture    String?         @unique
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  reservation       Reservation     @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Abonnement {
  id                String          @id @default(cuid())
  userId            String
  type              TypeAbonnement
  dateDebut         DateTime        @default(now())
  dateFin           DateTime
  reduction          Float           // pourcentage de réduction
  trajetsInclus     Int?            // null = illimité
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reduction {
  id                String    @id @default(cuid())
  type              String    // ETUDIANT, SENIOR, MILITAIRE, GROUPE, AVANCE, PROMOTION
  pourcentage       Float
  description       String?
  dateDebut         DateTime?
  dateFin           DateTime?
  actif             Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Bagage {
  id                String      @id @default(cuid())
  reservationId     String
  poids             Float
  volume            Float
  estGratuit        Boolean     @default(true)
  supplement        Float?      // coût supplémentaire si applicable
  etiquette         String?     // numéro d'étiquette
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  reservation       Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
}
